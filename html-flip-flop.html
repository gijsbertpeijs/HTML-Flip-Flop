<!DOCTYPE html>
<html>
    <head>
        <title>HTML Flip Flop</title>
        <script type="text/javascript">
            var img = new Image();
			var ctx;
			
			var tiles; // array containing tiles
			var selectedTiles = new Array(); // array containing selected tiles
			var numOfCols;
			var numOfRows;
			
			var availWidth;
			var availHeight;

			var scale = 1;
			var scaleInc = -0.1;
			
            function init() {
				ctx = document.getElementById('myCanvas').getContext('2d');
				document.getElementById('myCanvas').addEventListener('click', mouse_click, false);
				availWidth  = window.innerWidth-15;
				availHeight = window.innerHeight-15;
				// ctx.canvas.width = availWidth;
				// ctx.canvas.height = availHeight;
				
				numOfCols = 6;
				numOfRows = 4;
				tiles = new Array(numOfCols*numOfRows);
				initImageArray();
				
                img.src = "images/ani1.gif";
				setTimeout(drawAll,10);
            }

			function initImageArray() {
				for (var x = 0; x<numOfCols;x++) {
					for (var y = 0; y<numOfRows;y++) {
						var img = new Image();
						img.src = "images/C64.gif";
						img.flipped = false;
						img.X = x;
						img.Y = y;
						tiles[numOfCols * y + x] = img;
					}
				}
			}
			
			function flip(image, flipBack){
 				ctx.save();
				ctx.clearRect(image.X * 70,image.Y * 70,60,60);
				ctx.translate((image.X * 70) + 30,0); // to get it in the origin
				scale += scaleInc;
				scale = roundNumber(scale,1); // round number, otherwise you end up with 0.9999999 or something!
				ctx.scale(scale,1);
				ctx.drawImage(img,-30,image.Y * 70);
				ctx.translate((image.X * 70) - 30,0); //put it back
				ctx.restore();
				
				if (scale < 1) {
					if (scale == 0) {
						// switch the image source (back/front)
						if (flipBack) {
							// flipping to the generic side
							img.src = "images/ani1.gif";
						} else {
							// flipping to the image backside
							img.src = image.src;
						}
						scaleInc = scaleInc * -1; 
					}
					//  The timeout construct bellow doesn't work in IE. Who cares!
					setTimeout(flip, 8, image, flipBack); // call myself with an 8 ms delay.
				} else {
					scaleInc = scaleInc * -1; // Finished scaling. Restore scaleInc for the next flip
					img.src = "images/ani1.gif";
				}
            }
            
			function flipBack() {
				for (var idx = 0; idx<selectedTiles.length; idx++) {
					flip(selectedTiles[idx], true);
					// alert('woetie!');
				}
				
				document.getElementById('myCanvas').addEventListener('click', mouse_click, false);
				selectedTiles = new Array();
			}
			
			function drawAll(){
				for (var idx = 0; idx<tiles.length; idx++) {
					ctx.drawImage(img, tiles[idx].X * 70, tiles[idx].Y * 70);
				}
            }
			
			function mouse_click(ev){
				var x, y;

				// Get the mouse position relative to the canvas element.
				if (ev.layerX || ev.layerX == 0) { // Firefox
					x = ev.layerX;
					y = ev.layerY;
				} else if (ev.offsetX || ev.offsetX == 0) { // Opera
					x = ev.offsetX;
					y = ev.offsetY;
				}
				
				var selX = roundNumber((x+35)/70,0) - 1;
				var selY = roundNumber((y+35)/70,0) - 1;
				selectedTiles[selectedTiles.length] = tiles[numOfCols * selY + selX];
				
				// Check if 2 tiles have been flipped
				if (selectedTiles.length == 2) {
					document.getElementById('myCanvas').removeEventListener('click', mouse_click, false);
					flip(selectedTiles[selectedTiles.length - 1], false);
					setTimeout(flipBack,1000);
				} else {
					flip(selectedTiles[selectedTiles.length - 1], false);
				}
			}

			function roundNumber(number, digits) {
				var multiple = Math.pow(10, digits);
				var rndedNum = Math.round(number * multiple) / multiple;
				return rndedNum;
			}
			
        </script>
    </head>
    <body onload="init()">
        <canvas width="500" height="300" id="myCanvas">
			Oops, your browser does not support Canvas. Time to upgrade buddy.
		</canvas>
    </body>
</html>
