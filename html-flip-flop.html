<!DOCTYPE html>
<html>
    <head>
        <title>HTML Flip Flop</title>
        <script type="text/javascript">
            var img = new Image();
			var ctx;
			
			var images;
			var numOfCols;
			var numOfRows;
			var numSelected = 0;
			var selX = new Array(3);
			var selY = new Array(3);
			
			var availWidth;
			var availHeight;

			var scale = 1;
			var scaleInc = -0.1;
			
            function init() {
				ctx = document.getElementById('myCanvas').getContext('2d');
				document.getElementById('myCanvas').addEventListener('click', mouse_click, false);
				availWidth  = window.innerWidth-15;
				availHeight = window.innerHeight-15;
				// ctx.canvas.width = availWidth;
				// ctx.canvas.height = availHeight;
				
				numOfCols = 6;
				numOfRows = 4;
				images = new Array(numOfCols*numOfRows);
				initImageArray();
				
                img.src = "images/ani1.gif";
				setTimeout(drawAll,10);
            }

			function initImageArray() {
				for (var idx = 0; idx<images.length;idx++) {
					images[idx] = "images/C64.gif";
				}
			}
			
			function flip(selectedX, selectedY, flipBack){
 				ctx.save();
				ctx.clearRect(selectedX * 70,selectedY * 70,60,60);
				ctx.translate((selectedX * 70) + 30,0); // to get it in the origin
				scale += scaleInc;
				scale = roundNumber(scale,1); // round number, otherwise you end up with 0.9999999 or something!
				ctx.scale(scale,1);
				ctx.drawImage(img,-30,selectedY * 70);
				ctx.translate((selectedX * 70) - 30,0); //put it back
				ctx.restore();
				
				if (scale < 1) {
					if (scale == 0) {
						// switch the image source (back/front)
						if (flipBack) {
							// flipping to the generic side
							img.src = "images/ani1.gif";
						} else {
							// flipping to the image backside
							img.src = images[numOfCols * selectedY + selectedX];
						}
						scaleInc = scaleInc * -1; 
					}
					//  The timeout construct bellow doesn't work in IE. Who cares!
					setTimeout(flip, 8, selectedX, selectedY, flipBack); // call myself with an 8 ms delay.
				} else {
					scaleInc = scaleInc * -1; // Finished scaling. Restore scaleInc for the next flip
				}
            }
            
			function flipBack() {
				for (var idx=0;idx<2;idx++) {
					flip(selX[idx], selY[idx], true);
				}
				
				document.getElementById('myCanvas').addEventListener('click', mouse_click, false);
			}
			
			function drawAll(){
				for (var x = 0; x<numOfCols;x++) {
					for (var y = 0; y<numOfRows;y++) {
						ctx.drawImage(img,x*70,y*70);
					}
				}
            }
			
			function mouse_click(ev){
				var x, y;

				// Get the mouse position relative to the canvas element.
				if (ev.layerX || ev.layerX == 0) { // Firefox
					x = ev.layerX;
					y = ev.layerY;
				} else if (ev.offsetX || ev.offsetX == 0) { // Opera
					x = ev.offsetX;
					y = ev.offsetY;
				}
				
				numSelected++;
				
				selX[numSelected - 1] = roundNumber((x+35)/70,0) - 1;
				selY[numSelected - 1] = roundNumber((y+35)/70,0) - 1;
				
				// Check if 2 tiles have been flipped
				if (numSelected == 2) {
					document.getElementById('myCanvas').removeEventListener('click', mouse_click, false);
					flip(selX[numSelected - 1], selY[numSelected - 1], false);
					numSelected = 0;
					setTimeout(flipBack,1000);
				} else {
					flip(selX[numSelected - 1], selY[numSelected - 1], false);
				}
			}

			function roundNumber(number, digits) {
				var multiple = Math.pow(10, digits);
				var rndedNum = Math.round(number * multiple) / multiple;
				return rndedNum;
			}

        </script>
    </head>
    <body onload="init()">
        <canvas width="500" height="300" id="myCanvas">
			Oops, your browser does not support Canvas. Time to upgrade buddy.
		</canvas>
		<button onclick="drawAll()">Redraw</button>
    </body>
</html>
